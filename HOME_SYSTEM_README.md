# คู่มือระบบ HOME - Drug Dispenser Station

## ภาพรวมระบบ HOME

ระบบมี **3 แบบการ HOME** เพื่อให้การจ่ายยาแม่นยำ:

| แบบ | วิธีใช้ | เมื่อไหร่ใช้ | ระยะเวลา |
|-----|---------|--------------|----------|
| **1. HOME ปกติ** | หมุน 1 รอบ | Calibrate เบื้องต้น | ~2 วินาที |
| **2. HOME + จ่าย** | HOME แล้วจ่ายอัตโนมัติ | ใช้งานปกติ | ~5-10 วินาที |
| **3. HOME แบบหาเซนเซอร์** | วิ่งจนเจอเซนเซอร์ | เครื่องหยุดกลางทาง | สูงสุด 10 วินาที |

## วิธีการควบคุม

### ปุ่มบนเครื่อง
- **SW_CALC (PA0)**: HOME + จ่ายยา (แบบ 2)
- **SW_START (PA1)**: จ่ายยาโดยตรง (ไม่ HOME)

### ผ่าน Modbus (Register 12)
- **ค่า 1**: HOME ปกติ (แบบ 1)
- **ค่า 2**: HOME + จ่ายยา (แบบ 2)  
- **ค่า 3**: HOME แบบหาเซนเซอร์ (แบบ 3)

## การตั้งค่า

### ค่าที่ปรับได้ (ใน main.cpp)
```cpp
#define DISPENSE_ROTATIONS 10    // จำนวนรอบจ่าย
#define HOME_ROTATIONS 1         // จำนวนรอบ HOME ปกติ
```

### ค่าความเร็ว
- **HOME**: MOTOR_PWM_SLOW (1500) - ช้าเพื่อความแม่นยำ
- **DISPENSE**: MOTOR_PWM_DEFAULT (3000) - ปกติ

## ลำดับการทำงาน

### แบบ 1: HOME ปกติ
```
1. หมุน 1 รอบ ด้วยความเร็วช้า
2. หยุด เมื่อครบ 1 รอบ
3. เสร็จ
```

### แบบ 2: HOME + จ่ายยา  
```
1. หมุน 1 รอบ ด้วยความเร็วช้า (HOME)
2. รอให้ HOME เสร็จ
3. จ่ายยา 10 รอบด้วยความเร็วปกติ (ตามกำหนด)
4. เสร็จ
```

### แบบ 3: HOME แบบหาเซนเซอร์
```
1. ค่อยๆหมุนแบบช้าๆ
2. รอจนเซนเซอร์ตรวจจับได้
3. หยุด ทันทีที่เจอเซนเซอร์
4. เสร็จ (หรือ timeout 10 วินาที)
```

## การตรวจสอบสถานะ

### ผ่าน Serial Monitor
```
[Home] Started: 1 rotation calibration
[Home] Completed at 1 rotation
[Home Seek] Started: Seeking home sensor...
[Home Seek] Sensor detected - Home position found!
```

### ผ่าน Modbus Status (Register 20)
- **Bit 5 = 1**: กำลังทำ HOME
- **Bit 2 = 1**: เจอ HOME แล้ว
- **Bit 4 = 1**: อยู่ที่ตำแหน่ง HOME

## การแก้ปัญหา

| ปัญหา | สาเหตุที่เป็นไปได้ | วิธีแก้ |
|-------|----------------|---------|
| HOME ไม่ทำงาน | เซนเซอร์เสีย | ตรวจสอบ SEN_1_PIN (PB9) |
| หาเซนเซอร์ไม่เจอ | ตำแหน่งผิด | ย้ายเครื่องใกล้เซนเซอร์ |
| Timeout 10 วินาที | เซนเซอร์ไกลเกินไป | ใช้ HOME แบบ 1 หรือ 2 แทน |

## การปรับแต่งสำหรับผู้พัฒนา

### ไฟล์สำคัญ
- `include/dispense.h` - ประกาศฟังก์ชัน HOME
- `src/dispense.cpp` - การทำงาน HOME  
- `src/main.cpp` - การจัดการปุ่ม
- `src/modbus_handler.cpp` - การควบคุมผ่าน Modbus

### ฟังก์ชันหลัก
```cpp
void home_start(uint32_t rotations, int motorSpeed);  // HOME ปกติ
void home_seek_start(int motorSpeed);                 // HOME หาเซนเซอร์
bool is_home_completed();                             // ตรวจสอบเสร็จหรือยัง
```

## เคล็ดลับการใช้งาน

1. **ใช้ HOME แบบ 2** สำหรับการใช้งานปกติ (มีทั้ง calibrate และจ่าย)
2. **ใช้ HOME แบบ 3** เมื่อเครื่องหยุดกลางทางและต้องการหาตำแหน่งใหม่  
3. **ดู Serial Monitor** เพื่อติดตามการทำงานแบบ real-time
4. **ตรวจสอบ Status Bits** เพื่อรู้สถานะปัจจุบัน

ระบบนี้ให้ความยืดหยุ่นสูง: **ปุ่ม manual** และ **Modbus remote** ใช้ร่วมกันได้
```

ระบบนี้ให้ความยืดหยุ่นสูง: **ปุ่ม manual** และ **Modbus remote** ใช้ร่วมกันได้